<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assembly</title>

    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/_styles/site.css">
    <link rel="stylesheet" href="/_styles/page.css">
    <link rel="stylesheet" href="/_styles/guide.css">

    <!-- codemirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.59.4/codemirror.min.js" integrity="sha512-M1DpFDDFHNgGdgVsSkTP1sjfWC7mQFJM3obQo8gyKHbZmbmr95Kl9wPYa5T70BFQBi0+/TlcG6IZDLowJCbKBQ==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.59.4/codemirror.min.css" integrity="sha512-xIf9AdJauwKIVtrVRZ0i4nHP61Ogx9fSRAkCLecmE2dL/U8ioWpDvFCAy4dcfecN72HHB9+7FfQj3aiO68aaaw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.59.4/mode/gas/gas.min.js" integrity="sha512-9kcKyiyWVRjJkMfhrkUfbrnFw/0CAgln6ISmRVoGMDaPWN+VjBKcvLpqhJNhO9fQEgULoZ8jcC5GVtMV4ZSAsQ==" crossorigin="anonymous"></script>
    <script src="/_scripts/init_codemirror.js" defer></script>

</head>
<body>
    <header>
        <a id="Back" class="clickable" href="../" target="_self"><img src="/_media/back.svg" alt="back"></a>
        <h1>Assembly</h1>
    </header>
    <div id="__MAIN__">
        <h1>Table of Contents</h1>
        <ul>
            <li class="clickable"><a href="#Guides">
                Guides
            </a></li>
            <li class="clickable"><a href="#Running-Assembly">
                Running 6502 Assembly
            </a></li>
            <li class="clickable"><a href="#Structure">
                ASM Code Structure
            </a></li>
            <li class="clickable"><a href="#Address-Space">
                Address Space
            </a></li>
            <li class="clickable"><a href="#Accessing-Memory">
                Accessing Memory
            </a></li>
        </ul>


        <h1 id="Guides">Guides</h1>
        <p>
            There are a lot of fantastic resources about 65C02 assembly. Refer to these:
        </p>
        <ul>
            <li class="clickable external-link"><a href="http://www.obelisk.me.uk/65C02/reference.html" target="_blank" rel="noopener noreferrer">
                65C02 Reference
            </a></li>
            <li class="clickable external-link"><a href="https://github.com/ucsbieee/arcade/raw/main/assembly-level/tools/6502-emulator/6502.chm" target="_blank" rel="noopener noreferrer">
                Kowalski 65C02 Reference
            </a></li>
            <li class="clickable external-link"><a href="https://youtu.be/WEliEAc3ZyA" target="_blank" rel="noopener noreferrer">
                Stephen Edwards 6502 Instruction Overview Video
            </a></li>
            <!-- <li class="clickable external-link"><a href="https://www.youtube.com/watch?v=LnzuMJLZRdU&list=PLowKtXNTBypFbtuVMUVXNR0z1mu7dp7eH" target="_blank" rel="noopener noreferrer">
                Ben Eater 6502 Computer Video Series
            </a></li> -->
        </ul>


        <h1 id="Running-Assembly">Running 6502 Assembly</h1>
        <div class="clickable external-link center"><a href="https://github.com/ucsbieee/arcade/tree/main/assembly-level/tools" target="_blank" rel="noopener noreferrer">
            6502 Assembly Tools
        </a></div>
        <p>
            There are three tools we will use to write/run/test 6502 assembly: <u>Daryl&rsquo;s Kowalski 6502 Simulator</u>, <u>VASM</u>, and <u>py65</u>.
        </p>
        <ul>
            <li>
                The Kowalski simulator is a 65C02 IDE with debugging and autocompletion <em>(Windows only)</em>
            </li>
            <li>
                VASM is an assembler for creating machine code
            </li>
            <li>
                py65 is a command line simulator that can dump memory
            </li>
        </ul>
        <p>
            To select your code, enter its path in <code><a class="blue" href="https://github.com/ucsbieee/arcade/blob/main/assembly-level/src/rom.asm" target="_blank" rel="noopener noreferrer">rom.asm</a></code>.
        </p>
        <h2>Kowalski Simulator Setup</h2>
        <ol>
            <li>
                Set the value of <code>__KOWALSKI__</code> in <code><a class="blue" href="https://github.com/ucsbieee/arcade/blob/main/assembly-level/src/options.asm" target="_blank" rel="noopener noreferrer">options.asm</a></code> to 1.
            </li>
            <li>
                Open <code><a class="blue" href="https://github.com/ucsbieee/arcade/blob/main/assembly-level/src/arcade.asm" target="_blank" rel="noopener noreferrer">arcade.asm</a></code> in the Kowalski Simulator.
            </li>
            <li>
                While the <code>arcade.asm</code> window is active, press <code>F7</code> to assemble then <code>F6</code> to debug.
            </li>
            <li>
                Press either <code>F5</code> to run, or <code>F11</code> to step through.
            </li>
        </ol>


        <h2>VASM Setup</h2>
        <ol>
            <li>
                Set the value of <code>__VASM__</code> in <code><a class="blue" href="https://github.com/ucsbieee/arcade/blob/main/assembly-level/src/options.asm" target="_blank" rel="noopener noreferrer">options.asm</a></code> to 1.
            </li>
            <li>
                Change directory to <code><a class="blue" href="https://github.com/ucsbieee/arcade/tree/main/assembly-level/src" target="_blank" rel="noopener noreferrer">assembly-level/src/</a></code> and run <code>make arcade</code>.
            </li>
            <li>
                View the assembled machine code in <code>arcade.bin</code> with a hex editor.
            </li>
            <li>
                Run the code assembled code in py65 with <code>make dump</code>.
            </li>
        </ol>


        <h1 id="Structure">ASM Code Structure</h1>
        <p>
            All assembly ROM files must have three subroutines: <code>do_logic</code>, <code>reset</code>, and <code>fill_vram</code>. Failure to include these subroutines will prevent the assembler from working.
        </p>
        <ul>
            <li><code>reset</code>: run once at the beginning of the code</li>
            <li><code>do_logic</code>: run 60 times a second. Put as much game logic here as you can. However, do not touch the VRAM (addresses <code>$3700-$3fff</code>)</li>
            <li><code>fill_vram</code>: run after <code>do_logic</code>, once in the vertical blanking area. Here, you can touch the VRAM</li>
        </ul>
        <p>
            For more information, watch this:
        </p>
        <div class="center-within">
            <iframe width="560" height="315" src="https://www.youtube.com/embed/bQgF7crGjTo" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p>
            Example code:
        </p>
        <textarea class="code" mode="gas" src="https://raw.githubusercontent.com/ucsbieee/arcade/main/arcade-game_template/assembly-level/game.asm"></textarea>



        <h1 id="Address-Space">Address Space</h1>
        <p>
            You should be experienced with C++ pointers, which are memory addresses that point somewhere in RAM. However, EVERYTHING that the 6502 interacts with must have a memory address. This includes ROM, RAM, VRAM, the game controllers, etc. At the moment, this is the proposed address space of the 6502:
        </p>
        <div class="clickable external-link center"><a href="https://github.com/ucsbieee/arcade/blob/main/address%20space.txt" target="_blank" rel="noopener noreferrer">
            address space.txt
        </a></div>
        <p>
            Here are the labels that you can use in assembly code:
        </p>
        <div class="clickable external-link center"><a href=" https://github.com/ucsbieee/arcade/blob/main/assembly-level/src/labels.asm" target="_blank" rel="noopener noreferrer">
            labels.asm
        </a></div>
        <!-- <textarea src="https://raw.githubusercontent.com/ucsbieee/arcade/main/address%20space.txt"></textarea> -->
        <div>Summary:</div>
        <ul>
            <li>
                The zero page takes up <code>$0000-$00ff</code>. It enables &ldquo;Zero Page Indirect&rdquo; addressing.
            </li>
            <li>
                The VRAM takes up <code>$3700-$3fff</code>. Filling this will update the screen.
            </li>
            <li>
                The firmware ROM takes up <code>$4000-$6fff</code>. All firmware subroutines must have an origin within that range.
            </li>
            <li>
                ROM takes up <code>$8000-$ffff</code>.
            </li>
        </ul>
        <p>
            It is important that we map this out ahead of time to be sure we stay consistent. Any time you use any memory location, please refer to this table. Any time you create a new entry in the zero page or I/O in <code><a class="blue" href=" https://github.com/ucsbieee/arcade/blob/main/assembly-level/src/labels.asm" target="_blank" rel="noopener noreferrer">labels.asm</a></code>, please add it to the table.
        </p>



        <h1 id="Accessing-Memory">Accessing Memory</h1>
        <p>
            Since registers are only 8 bits, we cannot load entire 16-bit addresses into registers. However, we can load load 16-bit addesses into zero-page registers. Then, we can use &ldquo;Zero Page Indirect&rdquo; addressing to access any address. Observe this linked list traversal program:
        </p>

        <div class="clickable external-link center"><a href="/_code/assembly/linked_list.asm" download>
            linked_list.asm
        </a></div>
        <textarea class="code" mode="gas" src="/_code/assembly/linked_list.asm"></textarea>

    </div>
</body>
</html>
